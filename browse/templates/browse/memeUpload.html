

{% extends 'browse/base.html' %}
{% load static %}

{% load tagconstants %}


{% block header %}
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
    <script src="{% static 'browse/js/spectrum.js' %}"></script>

    <script type="text/javascript" src="{% static 'browse/js/jquery.memegenerator.min.js' %}"></script>

    <link rel="stylesheet" type="text/css" href="{% static 'browse/css/jquery.memegenerator.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'browse/css/spectrum.css' %}">
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <style>
        h2 {
            display: block;
            text-align: center;
        }

        .example {
            margin: 0 0 10% 0;
        }

        .bootstrap {
            width: 600px;
            margin-right: auto;
            margin-left: auto;
        }

        .save button {
            display: block;
            width: 100%;
            margin-bottom: 15px;
            font-size: 24px;
        }

        #preview {
            min-height: 200px;
            background-color: #EFEFEF;
            font-family: monospace;
            overflow-y: auto;
        }

        #preview img {
            max-width: 100%;
        }
    </style>

    <title>Upload Meme | {% constant "Website_Name" %}</title>
{% endblock %}


{% block body-content %}

    <div class="container" style="max-width: 95%">
        <h1>Add Template</h1>

        <hr>
        <h3 class="text-danger">Upload Image size less than {% constant "MAX_IMGSIZE" %} MB</h3>

        <form method="post" enctype="multipart/form-data" class="form-horizontal" role="form">
            {% csrf_token %}
            <div class="example horizontal">
                <img src="{% static 'browse/images/memeLoad.jpg' %}" id='memeImg'>

                <div class="mg-controls">

                    <h3>Template info</h3>

                    <input type='file' onchange="readURL(this);"/>

                    <div class="form-group w-75">
                        <label class=" control-label">Template Caption:</label>
                        <input class="form-control" type="text" name="tmplt_caption" id="tmplt_caption">
                        <small id="emailHelp" class="form-text text-muted">We'll never share your email with
                            anyone else.
                        </small>
                    </div>

                    <div class="form-group w-75">
                        <label class="control-label">Add Keywords:</label>
                        <div>
                            <ol style="display: inline" id="added_keywords">
                            </ol>
                        </div>

                        <input type="hidden" name="ingrds" id="ingrds">

                        <input class="awesomplete form-control" id="ingrd_input"
                               style="border: 1px solid #ccc; border-radius: 4px;padding: 5px 6px;"
                               list="ingredient_list"/>
                        <datalist id="ingredient_list">
                            {% for ingrd in ingredient_list %}
                                <option>{{ ingrd.name }}</option>
                            {% endfor %}
                        </datalist>

                        <script>
                            $(document).ready(function () {
                                $(window).keydown(function (event) {
                                    if (event.keyCode == 13) {
                                        event.preventDefault();
                                        return false;
                                    }
                                });
                                $('#ingrd_input').bind("enterKey", function (e) {
                                    $("ol").append("<li id=\"myId1\">" + $("#ingrd_input").val() + ' ' + "<a href=\"#\" class=\"remove\">X</a></li>");
                                    $('#ingrd_input').val("");
                                });
                                $('#ingrd_input').keyup(function (e) {
                                    if (e.keyCode == 13) {
                                        $(this).trigger("enterKey");
                                    }
                                });
                                $("#remove_li").click(function () {
                                    $("li:last").remove();
                                });
                                $("ol").on('click', '.remove', function () {
                                    $(this).parents('li').remove();
                                });

                            });
                        </script>
                    </div>
                </div>

                <script type="text/javascript">
                    function readURL(input) {
                        if (input.files && input.files[0]) {
                            var reader = new FileReader();

                            reader.onload = function (e) {
                                $('#memeImg')
                                    .attr('src', e.target.result);
                            };

                            reader.readAsDataURL(input.files[0]);
                        }
                    }
                </script>

                <div class="form-group">
                    <label class="col-md-3 control-label"></label>
                    <div class="col-md-8">

                        <input type="submit" class="btn btn-primary" value="Upload" id="confirm_upload">
                        <span></span>
                        <input type="reset" class="btn btn-danger" value="Cancel">
                    </div>
                </div>


            </div>

        </form>
    </div>




    <script type="text/javascript">

        $(".example.default img").memeGenerator({});

        $(".example.bootstrap img").memeGenerator({
            useBootstrap: true
        });

        $(".example.horizontal img").memeGenerator({
            useBootstrap: true,
            layout: "horizontal",
            previewMode: "css",
            defaultTextStyle: {
                font: "'Comic Sans', Arial",
                lineHeight: 2
            },
            captions: [
                "PREDEFINED text on top"
            ]
        });


        $("#example-save").memeGenerator({
            useBootstrap: true
        });


        $("#save").click(function (e) {
            e.preventDefault();

            var imageDataUrl = $("#example-save").memeGenerator("save");

            $.ajax({
                url: "http://127.0.0.1:8000/save-img",
                type: "POST",
                data: {
                    image: imageDataUrl
                },
                dataType: "json",
                success: function (response) {
                    $("#preview").html(
                        $("<img>").attr("src", response.filename)
                    );
                },
                error: function () {
                    alert('This demo uses communication with the server which is not implemented here.');
                }
            });
        });

        $("#download").click(function (e) {
            e.preventDefault();
            $("#example-save").memeGenerator("download");
        });

        $("#serialize").click(function (e) {
            $("#preview").html($("#example-save").memeGenerator("serialize"));
        });
    </script>

    <script>


        function getBase64Image(imgElem) {
            var c = document.createElement('canvas');
            var img = document.getElementById(imgElem);
            c.height = img.naturalHeight;
            c.width = img.naturalWidth;
            var ctx = c.getContext('2d');

            ctx.drawImage(img, 0, 0, c.width, c.height);
            return c.toDataURL();
        }

        function dataURLtoBlob(dataurl) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type: mime});
        }

        var csrftoken = getCookie('csrftoken');
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });


        $("#confirm_upload").on('click', function (e) {
            e.preventDefault();
            var category = $('#category').val();
            var blob = getBase64Image('memeImg');
            var caption = $('#tmplt_caption').val();
            var keywords = '';
            var memeImage = $("#memeImg").memeGenerator("save");

            var compressed = LZString.compress(imageEditor.toDataURL());
            console.log("Size of compressed sample is: " + compressed.length);
            var dcmp = LZString.decompress(compressed);
            console.log("Sample is: " + dcmp.length);


            $('#added_keywords').each(function () {// id of ul
                var li = $(this).find('li')//get each li in ul
                li.each(function () {// id of ul
                    keywords += '\'' + $(this).text().trim().slice(0, -1).trim() + '\','
                });
                $('#ingrds').val(keywords.slice(0, -1));


            });

            textJson = [];

            $('.mg-textbox-text').each(function (i, obj) {

                var id = $(this).attr("title");
                var email = $(this).val();

                item = {}
                item ["text"] = obj.value;
                item ["style"] = $($('.mg-css-preview div')[i]).attr('style');
                textJson.push(item);

                {#console.log(obj.value + '  ' + $('.mg-textbox-size')[i].value + '  ' + $('.mg-textbox-text-color')[i].value + " " + $($('.mg-css-preview div')[i]).attr('style'));#}
            });

            $.ajax({
                type: "POST",
                headers: {
                    "X-CSRFToken": csrftoken
                },
                url: '/browse/upload/',
                data: {
                    'caption': caption,
                    'keywords': keywords,
                    'template': blob,
                    'memeImg': memeImage,
                    'text': textJson

                },
                dataType: 'json',
                success: function (data) {


                }
            });
            console.log(keywords);


        });
    </script>
{% endblock %}






